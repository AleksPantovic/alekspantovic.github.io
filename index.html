<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haiilo Plugin - User Data (Console Debug Only)</title>
  <script type="module">
    import { PluginAdapter } from 'https://cdn.jsdelivr.net/npm/@coyoapp/plugin-adapter/+esm';

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[index.html] Entered DOMContentLoaded');

      const adapter = new PluginAdapter();
      console.log('5. [PluginAdapter] Calling adapter.init()...');
      const initResponse = await adapter.init();
      console.log('6. [PluginAdapter] adapter.init() response:', initResponse);

      if (!initResponse || !initResponse.token) {
        console.error('[PluginAdapter] No token found in initResponse:', initResponse);
        return;
      }

      // Try to use the adapter's built-in fetch proxy (if available)
      if (typeof adapter.fetch === 'function') {
        try {
          console.log('[index.html] Using adapter.fetch to get users...');
          const users = await adapter.fetch('GET', '/api/users');
          console.log('[PluginAdapter] Users from adapter.fetch():', users);
        } catch (err) {
          console.error('[PluginAdapter] adapter.fetch() error:', err);
        }
      } else {
        // Fallback: direct fetch (will likely fail due to CORS or permissions)
        const token = initResponse.token;
        console.log('[PluginAdapter] Token obtained:', token);
        try {
          const res = await fetch('https://asioso.coyocloud.com/api/users', {
            headers: {
              Authorization: `Bearer ${token}`
            }
          });
          const text = await res.text();
          if (!res.ok) {
            console.error('[PluginAdapter] Direct fetch HTTP error:', res.status, text);
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          const data = JSON.parse(text);
          console.log('[PluginAdapter] Users from direct fetch:', data);
        } catch (err) {
          console.error('[PluginAdapter] Direct fetch error:', err);
        }
      }
    });
  </script>
</head>
<body>
</body>
</html>
