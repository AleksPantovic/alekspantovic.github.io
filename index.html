<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haiilo Plugin - User Data (Console Debug Only)</title>
  <script type="module">
    // No need to import PluginAdapter or call adapter.init()
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[index.html] Entered DOMContentLoaded');

      // --- Workaround: fetch and eval pluginAdapter.js ---
      try {
        const response = await fetch('./pluginAdapter.js');
        if (!response.ok) {
          console.error('[index.html] Failed to fetch pluginAdapter.js:', response.status);
          return;
        }
        const pluginAdapterCode = await response.text();
        const module = { exports: {} };
        // Provide a dummy require for compatibility
        const require = (path) => ({});
        try {
          eval(pluginAdapterCode);
        } catch (evalError) {
          console.error('[index.html] Error during eval of pluginAdapter.js:', evalError);
          console.error('[index.html] pluginAdapter.js code was:', pluginAdapterCode);
          throw evalError;
        }

        if (module.exports.initializePlugin) {
          console.log('[index.html] Found initializePlugin in fetched code');
          const { sessionToken, backendFetchedUsers } = await module.exports.initializePlugin();
          console.log('[PluginAdapter] Session Token:', sessionToken);
          console.log('[PluginAdapter] Users from adapter.getUsers():', backendFetchedUsers);
          if (sessionToken === null) {
            console.error('[index.html] CORS error: Could not fetch session token. The browser was blocked by CORS when trying to access the Haiilo endpoint. This endpoint must allow your plugin origin or you must use a backend proxy.');
          }
        } else {
          console.error('[index.html] initializePlugin not found in fetched code');
        }
      } catch (error) {
        console.error('[index.html] Error fetching or executing pluginAdapter.js:', error);
      }
    });
  </script>
</head>
<body>
</body>
</html>
